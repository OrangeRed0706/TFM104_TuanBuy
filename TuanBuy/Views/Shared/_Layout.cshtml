@using Microsoft.AspNetCore.Mvc.Infrastructure
@using System.Security.Claims

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Ashion Template">
    <meta name="keywords" content="Ashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TuanBuy</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <!-- Js Plugins -->
    <script src="~/js/jquery-3.3.1.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/jquery.magnific-popup.min.js"></script>
    <script src="~/js/jquery-ui.min.js"></script>
    <script src="~/js/mixitup.min.js"></script>
    <script src="~/js/jquery.countdown.min.js"></script>
    <script src="~/js/jquery.slicknav.js"></script>
    <script src="~/js/owl.carousel.min.js"></script>
    <script src="~/js/jquery.nicescroll.min.js"></script>
    <script src="~/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--SingalR-->
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <!-- JS dropdown -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 通知 -->
    <link rel="stylesheet" href="https://anijs.github.io/lib/anicollection/anicollection.css" />


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--套用vue -->
    <script src="~/js/vue.min.js"></script>

    @*<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>*@
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!--加載 Google 平台庫-->
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <!-- Css Styles -->
    <link rel="stylesheet" href="~/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="~/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="~/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/style.css" type="text/css">
    <!-- 本機 -->
    <link rel="stylesheet" href="~/css/mystyle.css">
    <link rel="stylesheet" href="~/css/lynn.css" />

    <script src="~/js/signalr/HubConnection.js"></script>
</head>

<body>
    <!-- Header Section Begin -->
    <header class="header" id="layout">
        <div class="container">
            <div class="row layout-padding head-display">
                <a class="layout-img-logo" href=@Url.Action("Index","Home")><img src="~/img/Tuanbuylogo.png" alt=""></a>
                <p class="headsize-p1">|</p>
                <div class="head-p-width">
                    <a class="headsize" href="#" v-on:click="checkUser">開團</a>
                </div>
                @{
                    System.Diagnostics.Debug.Assert(User.Identity != null, "User.Identity != null");
                    if (User.Identity.IsAuthenticated)
                    {

                        <a class="bell-div" href="#" id="bell" v-on:click="showNotify">
                            <div class="bell-icon" tabindex="0" id="notifyBell">
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                                     y="0px" width="60px" height="40px" viewBox="0 0 50 30" enable-background="new 0 0 50 30"
                                     xml:space="preserve">
                                <g class="bell-icon__group" id="group"><!--鈴鐺擺動-->
                                                        <!--鈴鐺搖晃-->
                                <path class="bell-icon__ball" id="ball" fill-rule="evenodd" stroke-width="1.5" clip-rule="evenodd"
                                      fill="none" stroke="#currentColor" stroke-miterlimit="10"
                                      d="M28.7,25 c0,1.9-1.7,3.5-3.7,3.5s-3.7-1.6-3.7-3.5s1.7-3.5,3.7-3.5S28.7,23,28.7,25z" />
                                <path class="bell-icon__shell" id="shell" fill-rule="evenodd" clip-rule="evenodd" fill="#FFFFFF"
                                      stroke="#currentColor" stroke-width="2" stroke-miterlimit="10"
                                      d="M35.9,21.8c-1.2-0.7-4.1-3-3.4-8.7c0.1-1,0.1-2.1,0-3.1h0c-0.3-4.1-3.9-7.2-8.1-6.9c-3.7,0.3-6.6,3.2-6.9,6.9h0 c-0.1,1-0.1,2.1,0,3.1c0.6,5.7-2.2,8-3.4,8.7c-0.4,0.2-0.6,0.6-0.6,1v1.8c0,0.2,0.2,0.4,0.4,0.4h22.2c0.2,0,0.4-0.2,0.4-0.4v-1.8 C36.5,22.4,36.3,22,35.9,21.8L35.9,21.8z" />
                                                    </g>
                                                </svg>
                                <div class="notification-amount bellNotificationamout" id="notificationHello">
                                    <span>{{notifyCount}}</span>
                                </div>
                            </div>
                        </a>
                        <!-- The example -->
                        <div id="demo-notification" class="notifidiv">
                            <div id="notification">
                                <div class="toolbar">
                                    <div class="delete">
                                    </div>
                                    <a href=@Url.Action("MyNotify","MemberCenter")>
                                        <div class="app-icon load-more">
                                            <i class="fa fa-bell"></i>
                                        </div>
                                    </a>
                                </div>
                                <div class="notification-container list">
                                    <div class="item note note-gray fadeIn animated" v-for="item,index in message">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-circle" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text">
                                            {{item.content}}
                                        </div>
                                        <a href="#" class="note-close" v-on:click="closeNotify(index)" v-if="message.length>0">
                                            <i class="fa fa-close"></i>
                                        </a>
                                    </div>
                                    <div class="item note note-gray fadeIn animated" v-if="message.length==0">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text">
                                            目前沒有任何通知
                                        </div>

                                    </div>

                                    <div class="item note note-gray fadeIn animated" v-if="message.length>0">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-envelope-open" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text section">
                                            查看所有通知
                                        </div>

                                    </div>

                                </div>
                                @*<div class="read-more load-more">
                                    <i class="fa fa-bell"></i>
                                    Read More
                                    </div>*@
                            </div>
                        </div>
                        <!-- End example -->
                        <div class="dropdown display  dropnamefix">
                            <button class="btn" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-expanded="false">
                                <img v-bind:src="picPath.picPath" alt="Avatar" width="50" height="50" class="Largeheadsticker">
                                <p class="headnamesize display">{{user}}</p>
                            </button>
                            <div class="dropdown-menu dropmenufix" aria-labelledby="dropdownMenuButton">
                                <div>
                                    <a href=@Url.Action("Index", "MemberCenter")><i class="fa fa-user-o dorpiconcentermg"></i>會員中心</a>
                                </div>
                                @if (User.IsInRole("SystemAdmin"))
                                {
                                    <div>
                                        <a href=@Url.Action("Index", "TestBackMange")><i class="fa fa-user-o dorpiconcentermg"></i>後臺管理</a>
                                    </div>
                                }
                                <div>
                                    <a href=@Url.Action("ChatRoom", "Member")><i class="fa fa-comment-o dorpiconmessagemg" aria-hidden="true"></i>聊天室</a>
                                </div>
                                <div>
                                    <a href=@Url.Action("ReadyProduct", "Product")><i class="fa fa-bookmark-o dorpiconaddmg" aria-hidden="true"></i>收藏</a>
                                </div>
                                <div>
                                    <a href="#" v-on:click="logout"><i class="fa fa-sign-out dorpiconlogoutmg" aria-hidden="true"></i>登出</a>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="head-p-width2">
                            <a class="headsize" href=@Url.Action("Register","Home")>註冊</a>
                        </div>
                        <div class="head-p-width3">
                            <a class="headsize" href=@Url.Action("Login","Home")>登入</a>
                        </div>
                    }
                }

            </div>
        </div>
    </header>
    <!-- Header Section End -->
    @RenderBody();

    <!-- Footer Section Begin -->
    <footer class="ftborder">
        <div class="container">
            <div class="row layout-padding ft-display">
                <a class="layout-img-logo" href="#"><img src="/img/Tuanbuylogo.png" alt="logo"></a>
                <div class="ft-width">
                    <a class="headsize" href="#">關於</a>
                </div>
                <div class="ft-width2">
                    <a class="headsize" href="#">聯絡我們</a>
                </div>
                <div class="ft-width3">
                    <img class="qrcode-size" src="~/img/Qrcord.png" alt="QRcode">
                </div>
                <div class="footer__social">
                    <a href="#"><i class="fa fa-facebook"></i></a>
                    <a href="#"><i class="fa fa-twitter"></i></a>
                    <a href="#"><i class="fa fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>

<script>
    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    var userid = 0;
    var userAccount = '';
    var userName = '';
    var userPicPath = '';
    var userConnectionId = '';




    // 接受訊息事件
    connection.on("ReceiveMessage", function (user, message) {
        var msg = message;
        var encodedMsg = user + msg;
        let notify = {
            content: encodedMsg
        }

        layout.message.unshift(notify);
        layout.notifyCount += 1;

        //抓取鈴鐺通知給予class
        var ball = document.getElementById("ball");
        var group = document.getElementById("group");
        var notificationHello = document.getElementById("notificationHello");
        ball.classList.add('bellball');
        group.classList.add('bellgroup');
        notificationHello.classList.add('bellNotififShow');
        setTimeout(() => {
            ball.classList.remove('bellball');
            group.classList.remove('bellgroup');

            if (layout.notifyCount == 0) {
                notificationHello.classList.remove("bellNotififShow");
            }
        }, 3000);



        console.log(encodedMsg);
    });
</script>


<script>
    var fullShow = "@User.IsInRole("FullUser")";
    var helloMember = "@User.IsInRole("HelloMember")";
    var nomalShow = "@User.IsInRole("User")";
    var layout = new Vue({
        el: '#layout',
        data: {
            user: "",
            picPath: "",
            message:[],
            notifyCount:0
        },
        created:function() {
            $.ajax({
                type: "GET",
                url: "/Member/GetOnlineMember",
                success: function(response) {
                    userid = response.id;
                    userAccount = response.email;
                    userName = response.nickName;
                    if (userAccount != null) {

                        connection.start().then(function () {
                            console.log("前台的的連線成功");
                            //先取得當前使用者連線id
                            connection.invoke('getConnectionId')
                                .then(function (connectionId) {
                                    userConnectionId = connectionId;
                                }).catch(err => console.error("錯誤訊息："+err.toString()));;

                            // 加入群組
                            connection.invoke("AddUserList", userName, userid, userAccount).catch(function (err) {
                                return console.error(err.toString());
                            });
                            /*        connection.invoke("GetUserList");*/



                            //connection.invoke("GetAllNotify").then(() => {
                            //    console.log("取得通知成功！");
                            //});

                            connection.invoke("GetUserList").then((msg) => {
                            });
                        });
                    }
                }
            });
        },
        mounted: function() {
            let self = this;
            axios.get("/api/LoginAndRegister/")
                .then((resp) => {
                    self.user = resp.data; })
                .catch((res)=>res.response.data);
            axios.get("/api/MemberCenter/")
                .then((resp) => { self.picPath = resp.data })
                .catch((res)=>res.response.data);
            axios.get("/MemberCenter/GetIndexNotify").then((resp) => { this.message = resp.data });
        },
        methods: {
            logout: function() {
                axios.delete("/api/LoginAndRegister").then(() => {
                    window.location.href = "/Home/Index";
                });
            },
            checkUser:function() {
                if (helloMember === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '需要登入',
                        text: '請先登入網站會員！'
                    });
                    return;
                }
                if (fullShow === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '沒有權限',
                        text: '請把會員資料填寫完整！'
                    });
                    return;
                }
                else {
                    window.location.href = "/Product/Index";
                }
            },
            showNotify:function() {
                this.notifyCount = 0;
                notificationHello.classList.remove("bellNotififShow");
            },
            closeNotify:function(index) {
                this.message.splice(index, 1);
            }
        }

    });


</script>

@*通知*@
<script>
    $(document).ready(function () {
        $("#bell").click(function () {
            $("#demo-notification").toggle();
        });
    });
</script>

