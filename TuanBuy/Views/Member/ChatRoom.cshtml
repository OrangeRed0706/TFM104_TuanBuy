@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<style>
    .header {
        margin: -18px 0;
    }
</style>
<head style="margin: -18px 0">
    <meta charset="utf-8">
    <!--  This file has been downloaded from bootdey.com @@bootdey on twitter -->
    <!--  All snippets are MIT license http://bootdey.com/license -->
    <title>chat app - Bootdey.com</title>
    <meta charset="UTF-8">
    <meta name="description" content="Ashion Template">
    <meta name="keywords" content="Ashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TuanBuy</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <!-- Js Plugins -->
    <script src="~/js/jquery-3.3.1.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/jquery.magnific-popup.min.js"></script>
    <script src="~/js/jquery-ui.min.js"></script>
    <script src="~/js/mixitup.min.js"></script>
    <script src="~/js/jquery.countdown.min.js"></script>
    <script src="~/js/jquery.slicknav.js"></script>
    <script src="~/js/owl.carousel.min.js"></script>
    <script src="~/js/jquery.nicescroll.min.js"></script>
    <script src="~/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--SingalR-->
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <!-- JS dropdown -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 通知 -->
    <link rel="stylesheet" href="https://anijs.github.io/lib/anicollection/anicollection.css" />


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--套用vue -->
    <script src="~/js/vue.min.js"></script>

    @*<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>*@
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!--加載 Google 平台庫-->
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <!-- Css Styles -->
    <link rel="stylesheet" href="~/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="~/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="~/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="~/css/style.css" type="text/css">
    <!-- 本機 -->
    <link rel="stylesheet" href="~/css/mystyle.css">
    <link rel="stylesheet" href="~/css/lynn.css" />


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link href="~/css/ChatRoom.css" rel="stylesheet" />
    <link href="~/css/site.css" rel="stylesheet" />
</head>
<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Offcanvas Menu Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
        <div class="offcanvas__close">+</div>
        <div class="offcanvas__logo">
            <a href="./index.html"><img src="~/img/logo.png" alt=""></a>
        </div>
        <div id="mobile-menu-wrap"></div>
        <div class="offcanvas__auth">
            <a href=@Url.Action("Register","Home")>註冊</a>
            <a href=@Url.Action("Login","Home")>登入</a>
        </div>
    </div>
    <!-- Offcanvas Menu End -->
    <!-- Header Section Begin -->
    <header class="header" >
        <div class="container" id="layouttt">
            <div class="row layout-padding head-display">
                <a class="layout-img-logo" href=@Url.Action("Index","Home")><img src="~/img/Tuanbuylogo.png" alt=""></a>
                <p class="headsize-p1">|</p>
                <div class="head-p-width">
                    <a class="headsize" href="#" v-on:click="checkUser">開團</a>
                </div>
                @{
                    System.Diagnostics.Debug.Assert(User.Identity != null, "User.Identity != null");
                    if (User.Identity.IsAuthenticated)
                    {

                        <a class="bell-div" href="#" id="bell" v-on:click="showNotify">
                            <div class="bell-icon" tabindex="0" id="notifyBell">
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                                     y="0px" width="60px" height="40px" viewBox="0 0 50 30" enable-background="new 0 0 50 30"
                                     xml:space="preserve">
                                <g class="bell-icon__group" id="group"><!--鈴鐺擺動-->
                                                        <!--鈴鐺搖晃-->
                                <path class="bell-icon__ball" id="ball" fill-rule="evenodd" stroke-width="1.5" clip-rule="evenodd"
                                      fill="none" stroke="#currentColor" stroke-miterlimit="10"
                                      d="M28.7,25 c0,1.9-1.7,3.5-3.7,3.5s-3.7-1.6-3.7-3.5s1.7-3.5,3.7-3.5S28.7,23,28.7,25z" />
                                <path class="bell-icon__shell" id="shell" fill-rule="evenodd" clip-rule="evenodd" fill="#FFFFFF"
                                      stroke="#currentColor" stroke-width="2" stroke-miterlimit="10"
                                      d="M35.9,21.8c-1.2-0.7-4.1-3-3.4-8.7c0.1-1,0.1-2.1,0-3.1h0c-0.3-4.1-3.9-7.2-8.1-6.9c-3.7,0.3-6.6,3.2-6.9,6.9h0 c-0.1,1-0.1,2.1,0,3.1c0.6,5.7-2.2,8-3.4,8.7c-0.4,0.2-0.6,0.6-0.6,1v1.8c0,0.2,0.2,0.4,0.4,0.4h22.2c0.2,0,0.4-0.2,0.4-0.4v-1.8 C36.5,22.4,36.3,22,35.9,21.8L35.9,21.8z" />
                                                    </g>
                                                </svg>
                                <div class="notification-amount bellNotificationamout" id="notificationHello">
                                    <span>{{notifyCount}}</span>
                                </div>
                            </div>
                        </a>
                        <!-- The example -->
                        <div id="demo-notification" class="notifidiv">
                            <div id="notification">
                                <div class="toolbar">
                                    <div class="delete">
                                    </div>
                                    <a href=@Url.Action("MyNotify","MemberCenter")>
                                        <div class="app-icon load-more">
                                            <i class="fa fa-bell"></i>
                                        </div>
                                    </a>
                                </div>
                                <div class="notification-container list">
                                    <div class="item note note-gray fadeIn animated" v-for="item,index in message">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-circle" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text">
                                            {{item.content}}
                                        </div>
                                        <a href="#" class="note-close" v-on:click="closeNotify(index)" v-if="message.length>0">
                                            <i class="fa fa-close"></i>
                                        </a>
                                    </div>
                                    <div class="item note note-gray fadeIn animated" v-if="message.length==0">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text">
                                            目前沒有任何通知
                                        </div>

                                    </div>

                                    <div class="item note note-gray fadeIn animated" v-if="message.length>0">
                                        <div class="item-image note-icon">
                                            <i class="fa fa-envelope-open" aria-hidden="true"></i>
                                        </div>
                                        <div class="item-body note-text section">
                                            查看所有通知
                                        </div>

                                    </div>

                                </div>
                                @*<div class="read-more load-more">
                                    <i class="fa fa-bell"></i>
                                    Read More
                                    </div>*@
                            </div>
                        </div>
                        <!-- End example -->
                        <div class="dropdown display  dropnamefix">
                            <button class="btn" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-expanded="false">
                                <img v-bind:src="picPath.picPath" alt="Avatar" width="50" height="50" class="Largeheadsticker">
                                <p class="headnamesize display">{{user}}</p>
                            </button>
                            <div class="dropdown-menu dropmenufix" aria-labelledby="dropdownMenuButton">
                                <div>
                                    <a href=@Url.Action("Index", "MemberCenter")><i class="fa fa-user-o dorpiconcentermg"></i>會員中心</a>
                                </div>
                                @if (User.IsInRole("SystemAdmin"))
                                {
                                    <div>
                                        <a href=@Url.Action("Index", "TestBackMange")><i class="fa fa-user-o dorpiconcentermg"></i>後臺管理</a>
                                    </div>
                                }
                                <div>
                                    <a href=@Url.Action("ChatRoom", "Member")><i class="fa fa-comment-o dorpiconmessagemg" aria-hidden="true"></i>聊天室</a>
                                </div>
                                <div>
                                    <a href=@Url.Action("ReadyProduct", "Product")><i class="fa fa-bookmark-o dorpiconaddmg" aria-hidden="true"></i>收藏</a>
                                </div>
                                <div>
                                    <a href="#" v-on:click="logout"><i class="fa fa-sign-out dorpiconlogoutmg" aria-hidden="true"></i>登出</a>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="head-p-width2">
                            <a class="headsize" href=@Url.Action("Register","Home")>註冊</a>
                        </div>
                        <div class="head-p-width3">
                            <a class="headsize" href=@Url.Action("Login","Home")>登入</a>
                        </div>
                    }
                }

            </div>
        </div>
    </header>
    <!-- Header Section End -->

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    @*通知套件*@
    @*<link rel="stylesheet" href="https://unpkg.com/flowbite@1.4.2/dist/flowbite.min.css" />
        <script src="https://unpkg.com/flowbite@1.4.2/dist/flowbite.js"></script>*@

    <div class="container" id="app" style="margin-top:40px">
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="card chat-app">
                    <div id="plist" class="people-list">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fa fa-search"></i></span>
                            </div>
                            <input type="text" class="form-control" placeholder="Search..." v-model="userSearch">
                        </div>
                        <ul class="list-unstyled chat-list mt-2 mb-0" v-for="item in cotactpersons" v-if="item.chatRoomTitle!==null">
                            <li class="clearfix" v-on:click="getUserMessage(event)" :id="item.chatRoomId" v-if="userSearch=='' || item.chatRoomTitle.includes(userSearch)">
                                <img src="https://cdn2.ettoday.net/images/4803/d4803951.jpg" />
                                <div class="about">
                                    <div class="name center">{{item.chatRoomTitle}}</div>
                                    @*vue判斷式判斷使用者目前是否在線中 群組則不使用使用者燈號*@
                                    @*<div class="status" :id="item.id" v-if="item.status">
                                            <i class="fa fa-circle online"></i>online
                                        </div>
                                        <div class="status" :id="item.id" v-else>
                                            <i class="fa fa-circle offline"></i>offline
                                        </div>*@
                                </div>
                            </li>
                        </ul>
                        <ul class="list-unstyled chat-list mt-2 mb-0" v-for="user in item.users" v-else>
                            <li class="clearfix" v-on:click="getUserMessage(event)" :id="item.chatRoomId" v-if="userSearch=='' || user.nickName.includes(userSearch)">
                                <img :src="user.picPath" alt="avatar">
                                <div class="about">
                                    <div class="name">{{user.nickName}}</div>
                                    @*vue判斷式判斷使用者目前是否在線中*@
                                    <div class="status" :id="user.id" v-if="user.status">
                                        <i class="fa fa-circle online"></i>online
                                    </div>
                                    <div class="status" :id="user.id" v-else>
                                        <i class="fa fa-circle offline"></i>離線狀態
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="chat">
                        <div class="chat-header clearfix">
                            <div class="row">
                                <div class="col-lg-6">
                                    <a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
                                        <img :src="chatMessagePicPath" alt="avatar">
                                    </a>
                                    <div class="chat-about">
                                        <h6 class="m-b-0">{{chatMessageTitle}}</h6>
                                        @*<small>Last seen: 2 hours ago</small>*@
                                    </div>
                                </div>
                                <div class="col-lg-6 hidden-sm text-right">
                                    <label class="btn btn-info">
                                        <input id="upload_img" style="display:none;" type="file" multiple v-on:change="up">
                                        <i class="fa fa-photo"></i> 發送圖片
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="chat-history" id="history">
                            <ul class="m-b-0">
                                <li class="clearfix" v-for="p in messages" v-if="p.myMessages!==null || p.myMessageImage!==null">
                                    <div class="message-data text-right">
                                        <span class="message-data text-right">{{p.mynickName}}</span>
                                        <img :src="p.PicPath" alt="avatar">
                                        <br />
                                        <span class="message-data-time">{{p.createDate}}</span>
                                    </div>
                                    <div class="message other-message float-right">
                                        <div>{{p.myMessages}}</div>
                                        <img :src="p.myMessageImage" v-if="p.myMessageImage !==null" style="height:100px;width:100px ;">
                                    </div>
                                </li>
                                <li class="clearfix" v-else>
                                    <div class="message-data text-left">
                                        <img :src="p.PicPath" alt="avatar">
                                        <span class="message-data text-left">{{p.nickName}}</span>
                                        <br />
                                        <span class="message-data-time">{{p.createDate}}</span>
                                    </div>
                                    <div class="message my-message">
                                        <div>{{p.friendMessage}}</div>
                                        <img :src="p.friendMessageImage" v-if="p.friendMessageImage !==null" style="height:100px;width:100px ;">
                                    </div>
                                </li>
                            </ul>
                            
                        </div>
                        <div class="chat-message clearfix">
                            <div class="input-group mb-0">
                                <div class="input-group-prepend" v-on:click="sendMessage">
                                    <span class="input-group-text"><i class="fa fa-send"></i></span>
                                </div>
                                <temlate v-if="preview!==null">
                                    <img v-bind:src="preview" width="100" height="100"  hidden="hidden">
                                </temlate>
                                <input type="text" id="msg" v-on:keyup.enter="sendMessage" class="form-control" placeholder="Enter text here..." />
                            </div>
                        </div>

                        @*<div style="width: 30%;margin-left: 3%;position: relative;height: auto">
                                <img src="/MemberPicture/6378445022786806216cea7cb52cd19c5de6508aaada85628a.jpg" onclick="imgclick()" width="100%">
                                <input id="file" type="file" name="file" class="file" value="" onchange="upload()" style="display: none">
                            </div>*@
                    </div>
                </div>
            </div>

            @*<div id="toast-notification" class="absolute bottom-5 right-5 max-w-xs p-4 text-gray-900 bg-white rounded-lg shadow dark:bg-gray-800 dark:text-gray-300" role="alert">
                    <div class="flex items-center mb-3">
                        <span class="mb-1 text-sm font-semibold text-gray-900 dark:text-white">新訊息!</span>
                        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-notification" aria-label="Close">
                            <span class="sr-only">Close</span>
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="flex items-center">
                        <div class="relative inline-block shrink-0">
                            <img class="w-12 h-12 rounded-full" src="/MemberPicture/6378609833956106726cea7cb52cd19c5de6508aaada85628a.jpg" alt="Jese Leos image" />
                            <span class="absolute bottom-0 right-0 inline-flex items-center justify-center w-6 h-6 bg-blue-600 rounded-full">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                            </span>
                        </div>
                        <div class="ml-3 text-sm font-normal">
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">黃志輝</h4>
                            <div class="text-sm font-normal">黃志輝回覆訊息了哦!快去看看吧~</div>
                            <span class="text-xs font-medium text-blue-600 dark:text-blue-500">五秒前</span>
                        </div>
                    </div>
                </div>*@
        </div>
    </div>
    <!-- Footer Section Begin -->
    <footer class="ftborder">
        <div class="container">
            <div class="row layout-padding ft-display">
                <a class="layout-img-logo" href="#"><img src="/img/Tuanbuylogo.png" alt="logo"></a>
                <div class="ft-width">
                    <a class="headsize" href="#">關於</a>
                </div>
                <div class="ft-width2">
                    <a class="headsize" href="#">聯絡我們</a>
                </div>
                <div class="ft-width3">
                    <img class="qrcode-size" src="~/img/Qrcord.png" alt="QRcode">
                </div>
                <div class="footer__social">
                    <a href="#"><i class="fa fa-facebook"></i></a>
                    <a href="#"><i class="fa fa-twitter"></i></a>
                    <a href="#"><i class="fa fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->

</body>
</html>
<script>
    var fullShow = "@User.IsInRole("FullUser")";
    var helloMember = "@User.IsInRole("HelloMember")";
    var nomalShow = "@User.IsInRole("User")";
    var layout = new Vue({
        el: '#layout',
        data: {
            user: "",
            picPath: "",
            message: "",
        },
        mounted: function() {
            let self = this;
            axios.get("/api/LoginAndRegister/")
                .then((resp) => {
                    self.user = resp.data; })
                .catch((res)=>res.response.data);
            axios.get("/api/MemberCenter/")
                .then((resp) => { self.picPath = resp.data })
                .catch((res)=>res.response.data);
        },
        methods: {
            logout: function() {
                axios.delete("/api/LoginAndRegister").then(() => {
                    window.location.href = "/Home/Index";
                });
            },
            checkUser:function() {
                if (helloMember === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '需要登入',
                        text: '請先登入網站會員！'
                    });
                    return;
                }
                if (fullShow === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '沒有權限',
                        text: '請把會員資料填寫完整！'
                    });
                    return;
                }
                else {
                    window.location.href = "/Product/Index";
                }
            }
        }
    });

</script>
<script>
    const options = {
        year: 'numeric',    // 年: 使用4位數
        month: '2-digit',   // 月: 使用2數位
        day: '2-digit',     // 日: 使用2數位
        hour12: false,      // 12小時制: 不使用
        hour: '2-digit',    // 時: 使用2數位
        minute: '2-digit',  // 分: 使用2數位
        second: '2-digit'   // 秒: 使用2數位
    };
    //Hub連線註冊
    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
    //    console.log(connection.status)
    ////先抓取目前連線使用者並註冊Hub
    var userid = 0;
    var userAccount = '';
    var userName = '';
    var userPicPath = '';
    var userConnectionId = '';
    class User {
        chatRoomId;
        chatRoomTitle = '';
        nickName = '';
        userAccount = '';
        PicPath = '';
        id = 0;
        status = false;
    }
    class ContactPerson {
        chatRoomId;
        chatRoomTitle = '';
        users = [];
    }
    class Message {
        memberId = '';
        mynickName = userName;
        nickName = '';
        messageId = '';
        friendMessage = '';
        createDate = '';
        PicPath = '';
        myMessageImage = null;
        friendMessageImage = null;
    }

    var app = new Vue({
        el: '#app',
        data: {
            cotactperson: new ContactPerson(),
            message: new Message(),
            cotactpersons: [],
            friendNickName: '',
            messages: [],
            userAccount: '',
            friendAccount: '',
            nowChatRoomId: '',
            chatMessageTitle: '個人聊天室',
            chatMessagePicPath: '',
            preview: null,
            messageimgahe: '',
            onreload: true,
            userSearch: '',
            notifyCount:0
        },
        created: function() {
            $.ajax({
                type: "GET",
                url: "/Member/GetOnlineMember",
                success: function(response) {
                    userid = response.id;
                    userAccount = response.email;
                    userName = response.nickName;
                    userPicPath = '/MemberPicture/' + response.picPath;
                    app.chatMessageTitle = userName + '個人聊天室';
                    app.chatMessagePicPath = userPicPath;
                    if (userAccount != null) {
                        connection.start().then(function() {
                            //先取得當前使用者連線id
                            connection.invoke('getConnectionId')
                                .then(function(connectionId) {
                                    userConnectionId = connectionId;
                                }).catch(err => console.error(err.toString()));;

                            // 加入群組
                            connection.invoke("AddUserList", userName, userid, userAccount).catch(function(err) {
                                return console.error(err.toString());
                            });
                            /*        connection.invoke("GetUserList");*/

                            connection.invoke("GetOnlineUserList", userid).catch(function(err) {
                                return console.error(err.toString());
                            });

                            //connection.invoke("GetAllNotify").then(() => {
                            //    console.log("取得通知成功！");
                            //});

                            connection.invoke("GetUserList").then((msg) => {
                            });
                        });
                    }
                },
                error: function(response) {
                    console.log('尚未登入');
                }
            });
        },
        mounted: function() {
            $.ajax({
                type: "POST",
                url: "/Member/getChatRoomUser",
                success: function(response) {
                    /*var res1 = document.getElementsByClassName('list-unstyled chat-list mt-2 mb-0');*/
                    for (var i = 0; i < response.length; i++) {
                        var cotactobject = new ContactPerson();
                        cotactobject.chatRoomId = response[i].chatRoomId;
                        cotactobject.chatRoomTitle = response[i].chatRoomTitle;
                        for (var s = 0; s < response[i].users.length; s++) {
                            var userobject = new User();
                            userobject.chatRoomId = response[i].chatRoomId;
                            userobject.chatRoomTitle = response[i].chatRoomTitle;
                            userobject.nickName = response[i].users[s].nickName;
                            userobject.picPath = '/MemberPicture/' + response[i].users[s].picPath;
                            userobject.id = response[i].users[s].userId;
                            userobject.userAccount = response[i].users[s].userAccount;
                            userobject.status = false;
                            cotactobject.users.push(userobject);
                        }
                        app.cotactpersons.push(cotactobject);

                    }
                    app.$nextTick(function() {
                        var res1 = document.getElementById('' + response[0].chatRoomId);
                        res1.click();
                    })
                    getChatheight();
                },
                error: function(response) {
                    alert(response);
                }
            });
        },
        methods: {
            sendMessage: function() {
                //判斷使用者是否只有輸入文字 如果帶有圖片則使用上面寄發圖片及文字方法
                var messagecontext = document.getElementById("msg").value;
                if (messagecontext != '' && app.preview == null) {
                    connection.invoke("SendPrivateMessage", app.nowChatRoomId, userid, messagecontext);
                    var message = new Message();
                    const date = new Date(Date.now());
                    message.createDate = new Intl.DateTimeFormat('zh-TW', options).format(date)
                    message.myMessages = messagecontext;
                    message.PicPath = userPicPath;
                    app.messages.push(message);
                    document.getElementById("msg").value = '';
                }
                //聊天室視窗自動下滑
                getChatheight();
            },
            /*取得與好友對話資訊*/
            getUserMessage: function(event) {
                //先將聊天室訊息清除
                app.messages = [];
                //將聊天室id帶回vue參數
                app.nowChatRoomId = event.currentTarget.id;
                //查詢目前點擊的ID帶入聊天室Title
                let chatdata = app.cotactpersons.find(x => x.chatRoomId == event.currentTarget.id);
                if (chatdata.chatRoomTitle == null) {
                    app.chatMessageTitle = chatdata.users[0].nickName;
                    app.chatMessagePicPath = chatdata.users[0].picPath;
                } else {
                    app.chatMessageTitle = chatdata.chatRoomTitle;
                    //群組圖片
                    app.chatMessagePicPath = "https://cdn2.ettoday.net/images/4803/d4803951.jpg";
                }
                console.log(chatdata);
                $.ajax({
                    type: "POST",
                    url: "/Member/GetChatMessage",
                    data: { chatRoomId: event.currentTarget.id },
                    success: function(response) {
                        /*時間格式化*/
                        for (var i = 0; i < response.length; i++) {
                            app.message = new Message();
                            const date = new Date(response[i].createDate);
                            app.message.createDate = new Intl.DateTimeFormat('zh-TW', options).format(date)
                            app.message.memberId = response[i].memberId;

                            //將訊息進行分類處理
                            if (response[i].myMessage !== null || response[i].myMessageImage !== null) {
                                app.message.friendMessage = null;
                                app.message.myMessages = response[i].myMessage;
                                app.message.myMessageImage = response[i].myMessageImage;
                            } else {
                                app.message.myMessages = null;
                                app.message.friendMessage = response[i].friendMessage;
                                app.message.friendMessageImage = response[i].friendMessageImage;
                            }
                            app.message.PicPath = '/MemberPicture/' + response[i].picPath;
                            app.message.memberId = response[i].messageId;
                            app.message.nickName = response[i].nickName;
                            app.messages.push(app.message);
                        }
                        //聊天室視窗自動下滑
                        getChatheight();
                    },
                    error: function(response) {
                        alert(response);
                    }
                });
            },

            //上傳圖片方法
            up: function(event) {
                messageimgahe = event.target.files[0];
                var input = event.target;
                if (input.files) {
                    var reader = new FileReader();
                    reader.onload = (e) => {
                        this.preview = e.target.result;
                    }
                    this.image = input.files[0];
                    reader.readAsDataURL(input.files[0]);
                }
                app.sendImage();
            },
            //使用者寄送圖片方法
            sendImage: function () {
                var messagecontext = document.getElementById("msg").value;
                //todo 使用者傳送訊息圖片
                    //如果使用者寄發圖片則發ajax請求新增在呼叫Hub方式
                var bodyFormData = new FormData();
                bodyFormData.append('nowChatRoomId', app.nowChatRoomId);
                bodyFormData.append('userid', userid);
                bodyFormData.append('message', messagecontext);
                bodyFormData.append('connectionId', userConnectionId)
                bodyFormData.append('picPath', messageimgahe);

                $.ajax({
                    type: "POST",
                    url: "/Member/CreateChatMessage",
                    data: bodyFormData,
                    processData: false,
                    contentType: false,
                    success: function (resp) {
                        console.log(resp);
                        app.preview = null;
                        var message = new Message();
                        const date = new Date(Date.now());
                        message.createDate = new Intl.DateTimeFormat('zh-TW', options).format(date)
                        message.PicPath = userPicPath;
                        message.myMessages = messagecontext;
                        message.myMessageImage = resp;
                        app.messages.push(message);
                        //清除輸入框
                        document.getElementById("msg").value = '';
                        //觸發HUB接收事件
                        connection.invoke("SendPrivateImageMessage", app.nowChatRoomId, userid, userName, userPicPath, messagecontext, userConnectionId, resp);
                        //聊天室視窗自動下滑
                        getChatheight();
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            }
        },
    });


    var appp = new Vue({
        el: '#layouttt',
        data: {
            user: "",
            picPath: "",
            notifyCount:0,
            message:[],
        },
        methods: {
            showNotify:function() {
                this.notifyCount = 0;
                notificationHello.classList.remove("bellNotififShow");
            },
            closeNotify:function(index) {
                this.message.splice(index, 1);
            },
            checkUser:function() {
                if (helloMember === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '需要登入',
                        text: '請先登入網站會員！'
                    });
                    return;
                }
                if (fullShow === "False") {
                    Swal.fire({
                        icon: 'error',
                        title: '沒有權限',
                        text: '請把會員資料填寫完整！'
                    });
                    return;
                }
                else {
                    window.location.href = "/Product/Index";
                }
            },
            logout: function() {
                axios.delete("/api/LoginAndRegister").then(() => {
                    window.location.href = "/Home/Index";
                });
            },
        },
        mounted: function (){
            let self = this;
            axios.get("/api/LoginAndRegister/")
                .then((resp) => {
                    self.user = resp.data; })
                .catch((res)=>res.response.data);
            axios.get("/api/MemberCenter/")
                .then((resp) => { self.picPath = resp.data })
                .catch((res)=>res.response.data);
            axios.get("/MemberCenter/GetIndexNotify").then((resp) => { this.message = resp.data });
        }

    });

    //if (app.onreload) {
    //    app.onreload = false;
    //    window.location.reload();
    //}

    //第一次進入頁面查找好友是否在線
    connection.on('GetOnlineUserList', msg => {
        if (Object.keys(msg).length === 0) {
            console.log('目前尚未有好友在線中');
        }
        else {
            /*            console.log('這個是使用者目前好友在線名單');*/
            //目前好友在線名單
            //將使用者在線房間id存成物件
            var useronlineobject = [];
            for (let i = 0; i < msg.length; i++) {
                for (let s = 0; s < msg[i].chatId.length; s++) {
                    useronlineobject.push(msg[i].chatId[s]);
                }
            }
            //將目前該名使用者好友清單與在線清單比對
            for (let i = 0; i < app.cotactpersons.length; i++) {

                var result = useronlineobject.find(x => x == app.cotactpersons[i].chatRoomId);
                if (result != null && app.cotactpersons[i].chatRoomTitle == null) {
                    app.cotactpersons[i].users[0].status = true;
                }
            }
        }
    })

    /* 接收其他使用者傳來訊息*/
    connection.on('PrivateMsgRecevied', (message, currentUser, currentUserImg, getTodaynowChatRoomId) => {
        console.log(currentUser);
        var messagesobject = new Message();
        const date = new Date(Date.now());
        messagesobject.createDate = new Intl.DateTimeFormat('zh-TW', options).format(date)
        messagesobject.nickName = currentUser;
        messagesobject.friendMessage = message;
        messagesobject.PicPath = '/MemberPicture/' + currentUserImg;
        messagesobject.myMessages = null;
        console.log('接收訊息' + message + "標題" + currentUser)
        if (app.nowChatRoomId == getTodaynowChatRoomId) {
            console.log('接收成功' + getTodaynowChatRoomId)
            app.messages.push(messagesobject);
        }
        //聊天室視窗自動下滑
        getChatheight();
    })

    /* 接收其他使用者傳來的圖片訊息*/
    connection.on('PrivateImgMsgRecevied', (messagecontext, userName, userPicPath, imgMsgPicPath, getTodaynowChatRoomId) => {
        var messagesobject = new Message();
        const date = new Date(Date.now());
        messagesobject.createDate = new Intl.DateTimeFormat('zh-TW', options).format(date)
        messagesobject.nickName = userName;
        messagesobject.friendMessage = messagecontext;
        messagesobject.PicPath = userPicPath;
        messagesobject.friendMessageImage = imgMsgPicPath;
        messagesobject.myMessages = null;
        if (app.nowChatRoomId == getTodaynowChatRoomId) {
            app.messages.push(messagesobject);
        }
                                //聊天室視窗自動下滑
                        getChatheight();
    })



    ////監聽事件查看好友是否上線
    connection.on('SendOnlineUserList',
        msg => {
            if (Object.keys(msg).length !== 0) {
                console.log('您的好友' + msg.name + '已上線囉!' + 'id為' + msg.id);
                /*TODO*/
                if (!!document.getElementById('' + msg.id)) {
                    /*                app.cotactpersons.chatRoomId.find(x => x.chatRoomId == msg.id).status = true;*/
                    document.getElementById('' + msg.id).innerHTML = '<i class="fa fa-circle online"></i> 在線狀態';
                }
            }
        }
    )
    //聊天室視窗自動下滑
    function getChatheight() {
        app.$nextTick(function () {
            var result = document.getElementById('history')
            result.scrollTop = result.scrollHeight;
        })
    }
  


    connection.on("ReceiveMessage", function (user, message) {
        var msg = message;
        var encodedMsg = user + msg;
        let notify = {
            content: encodedMsg
        }

        layout.message.unshift(notify);
        layout.notifyCount += 1;

        //抓取鈴鐺通知給予class
        var ball = document.getElementById("ball");
        var group = document.getElementById("group");
        var notificationHello = document.getElementById("notificationHello");
        ball.classList.add('bellball');
        group.classList.add('bellgroup');
        notificationHello.classList.add('bellNotififShow');
        setTimeout(() => {
            ball.classList.remove('bellball');
            group.classList.remove('bellgroup');

            if (layout.notifyCount == 0) {
                notificationHello.classList.remove("bellNotififShow");
            }
        }, 3000);



        console.log(encodedMsg);
    });
</script>

<script>
    $(document).ready(function () {
        $("#bell").click(function () {
            $("#demo-notification").toggle();
        });
    });



</script>
